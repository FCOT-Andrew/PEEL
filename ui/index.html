<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>PEEL Quest</title>
		<link rel="icon" type="image/svg+xml" href="/ui/favicon.svg">
		<link rel="stylesheet" href="/ui/html_reset.css">
		<link rel="stylesheet" href="/ui/style.css">
		<link rel="stylesheet" href="/ui/layout.css">
		<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
	</head>
	<body>
		<div id="app">
			<h1>PEEL Quest</h1>
			<p>
				This is a very early prototype of an AI feedback assistant.
				You should only be here by the specific invitation of its creator.
				If you don't know who that is, you shouldn't be here.
			</p>
			<form v-on:submit.prevent="submitAssignment">
				<label for="class_code">Class Code:</label>
				<input type="text" name="class_code" id="class_code" v-model="class_code" placeholder="a1-b2-c3" v-bind:disabled="[2, 3, 4, 5].includes(submissionStage)">
				<label for="submission">Your Assignment:</label>
				<textarea name="submission" id="submission" v-model="submission" placeholder="Paste your assignment here." v-bind:disabled="[2, 3, 4, 5].includes(submissionStage)"></textarea>
				<input type="submit" v-bind:value="stageDescription" v-bind:disabled="[2, 3, 4, 5].includes(submissionStage)">
			</form>
			<p v-if="message" v-bind:class="{ emphasis: submissionStage === 0 }">{{ message }}</p>
		</div>
		<script>
			Vue.createApp({
				data() {
					return {
						class_code: null,
						submission: null,
						submissionStage: 1,
						message: null,
						submitAnimation: null,
					}
				},
				methods: {
					async submitAssignment() {
						if (!this.class_code || !this.submission) {
							this.submissionStage = 0;
							this.message = "Please provide both a class code and an assignment file.";
						} else {
							this.submitAnimation = setInterval(() => {
								this.submissionStage = (this.submissionStage < 5) ? this.submissionStage + 1 : 2;
							}, 600);
							this.submissionStage = 2;
							this.message = null;
							const body = new FormData();
							body.append("class_code", this.class_code);
							body.append("submission", this.submission);
							try {
								const response = await fetch("/api/submit_assignment", {
									method: "POST",
									body,
								});
								clearInterval(this.submitAnimation);
								if (response.ok) {
									const result = await response.json();
									this.submissionStage = 6;
									this.message = result.feedback;
								} else {
									throw new Error();
								}
							} catch (error) {
								this.submissionStage = 0;
								this.message = "There was an error submitting your assignment.";
								console.error(error);
							}
						}
					}
				},
				computed: {
					stageDescription() {
						const descriptions = [
							"Error. Try again?",
							"Submit assignment.",
							"Submitting.",
							"Submitting..",
							"Submitting...",
							"Submitting..",
							"Resubmit.",
						];
						return descriptions[this.submissionStage] || "Error. Try again?";
					},
				},
			}).mount("#app")
		</script>
	</body>
</html>